# 分布式系统认证方案

## 1. 什么是分布式系统

随着软件环境和需求的变化,软件的架构由单体结构演变为分布式架构,具有分布式架构的系统叫做分布式系统, 分布式系统的运行通常依靠网络, 他将单体结构的系统分为若干服务, 服务之间通过网络交互来完成用户的业务处理, 当前流行的微服务架构就是分布式系统的结构,如下图:

![image-20200728211244284](6.%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E8%AE%A4%E8%AF%81.assets/image-20200728211244284.png)

分布式系统具体如下基本特点:

1. **分布式:** 每个部分都可以独立部署,服务之间交互通过网络进行通信,比如:订单服务、商品服务
2. **伸缩性:** 每个部分都可以集群方式部署,并可针对部分节点进行硬件和软件扩容,具有一定的伸缩能力, 
3. **共享性:** 每个部分都可以作为共享资源并对外提供服务,多个部分可能有操作共享资源的情况
4. **开放性:** 每个部分根据需求都可以对外发布共享资源的访问接口, 并可允许第三方系统访问.

## 2  分布式纷争需求

分布式系统的每个服务的都会有认证,授权的需求，如果每个服务都实现一套认证授权逻辑会非常冗余,考虑到分布式系统共享性的特点,需要由独立的认证服务处理系统认证授权的请求,考虑分布式系统开放性的特点,不仅对系统内部服务提供认证,对第三放系统也要提供认证. 分布式认证的需求如下:

### 2.1 统一认证授权

提供独立的认证服务,统一处理认证授权

无论是不同类型的用户,还是不同种类的客户端(`web`端,`H5`、`APP`),均采用一致的认证,权限、会话机制,实现统一认证授权. 

要实现统一则认证方式必须可扩展,支持各种认证需求,比如:用户名密码认证、短信验证码、二维码、人脸识别等认证方式,并可以非常灵活的却换, 

### 2.2 应用接入认证

应提供扩展和开放能力,提供安全的系统对接机制,并可开放部分`API`给接入第三方使用,一方应用(内部系统服务)和三方应用(第三方应用) 均采用统一机制接入. 

## 3. 分布式认证方案

### 3.1 选型分析

#### 3.1.1 基于`session` 的认证方式

在分布式环境下,基于`session` 的认证会出现一个问题,每个应用服务都需要在`session` 中存储用户身份信息,通过负载均衡将本地的请求分配到另外一个应用服务需要将`session` 信息带过去,否则会重新认证

![image-20200728213838833](6.%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E8%AE%A4%E8%AF%81.assets/image-20200728213838833.png)

这个时候,通常的做法有下面几种:

**`session`复制:** 多台应用服务器之间同步`session`, 使`session` 保持一致,对外透明

**`session` 黏贴:** 当用户访问集群中某台服务器后,强制指定后续所有请求均落到此机器上.

**`session` 集中存储:** 将`session` 存入分布式缓存中, 所有服务器应用实例统一从分布式缓存中存取`session`

总体来说,基于`session` 认证的认证方式, 可以更好的在服务端对会话进行控制, 且安全性较高。但是,`session` 机制方式基于`cookie`, 在复杂多样的移动客户端上不能有效的使用,并且无法跨域,另外随着系统的扩展需提高`session`的复制、黏贴、存储的容错性. 

#### 3.1.2 基于`token`的认证方式

基于`token`的认证方式,服务端不用存储认证数据,易维护扩展性强, 客户端可以把`token` 存在任意地方,并且可以实现`web` 和`app` 统一认证机制. 其缺点也很明显,`token`由于自包含信息,因此一般数据量较大, 并且每次请求都需要传递,因此比较占带宽. 另外，`token` 的签名验签操作也会给`cpu` 带来额外的处理负担. 

![image-20200728215141768](6.%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E8%AE%A4%E8%AF%81.assets/image-20200728215141768.png)

### 3.2 技术方案

根据选型的分析,一般采用基于`token`的认证方式,它的优点是:

1. 适合统一认证的机制, 客户端、一方应用、三方应用都遵循一致的认证方案
2. `token`认证方式对第三方应用接入更适合,因为它更开放, 可使用当前有流行的开放协议`Oauth2.0`、`JWT`等. 
3. 一般情况服务端无需存储会话信息,减轻了服务端的压力. 

分布式系统认证技术方案见下图:

![image-20200728215553327](6.%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E8%AE%A4%E8%AF%81.assets/image-20200728215553327.png)

流程描述:

1. 用户通过接入方(应用)登陆, 接入方采用`Oauth2.0`方式 在统一认证服务(`UAA`) 中认证
2. 认证服务(`UAA`) 调用验证该用户的身份是否合法, 并获取用户权限信息
3. 认证服务(`UAA`) 获取接入方权限信息,并验证接入方是否合法. 
4. 若登陆用户以及接入方都合法,认证服务生成`jwt` 令牌返回给接入方,其中`jwt` 中包含了用户权限以及接入方权限. 
5. 后续, 接入方携带`jwt` 令牌对`API` 网关内的微服务资源进行访问. 

